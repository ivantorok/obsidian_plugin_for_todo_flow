# Walkthrough - FEAT-004: Perpetual Loop

We have successfully implemented Phase 2 (BDD) for the first feature of Elias 1.1: **Perpetual Loop & Victory Lap**.

> [!NOTE]
> **Archive Notice**: This record reflects the "Elias 1.1/1.2" monolithic architecture. The project has since moved to the "Lean Mobile" split (`ArchitectStack` / `FocusStack`). This file is retained for historical traceability only.

## Changes

### [Logic Layer] LoopManager
We introduced a stateless `LoopManager` to handle navigation logic.
- [LoopManager.ts](file:///home/ivan/projects/obsidian_plugin_for_todo_flow/src/services/LoopManager.ts)

### [UI Layer] LeanStackView
- Integrated `LoopManager`.
- Added a **Victory Lap** card that appears after the final task.
- Added "Restart Loop" and "Close Session" functionality.

## Verification Results

### Automated Tests
- **Unit Tests**: Passed. Verified wrap-around and Victory Lap state logic.
- **E2E Tests**: Passed. Verified the full journey from Task 1 -> Task 2 -> Victory Lap -> Restart -> Task 1.

### Evidence
![Victory Lap Card](file:///home/ivan/projects/obsidian_plugin_for_todo_flow/tests/e2e/failures/should_wrap_around_to_the_first_task_when_clicking_"Restart_Loop"_on_Victory_Lap_card.png)
> [!NOTE]
> The image above was captured during a "failed" run where it timed out waiting for the card, proving the card was visible but the test needed hardening. The test is now passing.

### Test Output
```text
Elias 1.1 (Focus & Momentum) Verification - FEAT-004: Perpetual Loop
   ✓ should show Victory Lap card after clicking NEXT on the final task
   ✓ should wrap around to the first task when clicking "Restart Loop" on Victory Lap card
```
