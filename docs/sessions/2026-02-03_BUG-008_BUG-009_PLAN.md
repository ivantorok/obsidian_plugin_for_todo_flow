# Fixes for Desktop Regression (BUG-008) and Sync Discrepancy (BUG-009)

This plan addresses the critical regression on desktop where duration buttons stopped working and the synchronization bug where `CurrentStack.md` changes are ignored/overwritten.

## User Review Required

> [!IMPORTANT]
> **Sync Reliability**: The fix for BUG-009 will change how `CurrentStack.md` reloads. If a conflict occurs, the plugin will prioritize the disk version during an external reload to ensure sync consistency.

## Proposed Changes

### [Component] BUG-008: Desktop Duration Buttons
Restore click functionality for duration adjustment buttons on desktop.

#### [MODIFY] [StackView.svelte](../../src/views/StackView.svelte)
- Investigate why `onclick` handlers on duration buttons are not firing.
- Ensure `pointer-events` or `handlePointerStart` are not blocking standard button clicks on non-touch devices.

---

### [Component] BUG-009: Sync Robustness
Ensure `CurrentStack.md` external modifications correctly update the UI and prevent state overwrites.

#### [MODIFY] [StackView.ts](../../src/views/StackView.ts)
- Modify `reload()` to pass a `forceDiskRead: true` flag to `setState`.
- Update `setState()` to skip restoration from `navState` (memory) if `forceDiskRead` is true, forcing a call to `loader.load()`.
- Implement a comparison check: only reload if the disk content actually differs from the last saved state to avoid unnecessary UI flickering during internal saves.

#### [NEW] [sync_robustness.spec.ts](../../tests/e2e/sync_robustness.spec.ts)
- E2E test that verifies:
  1. Opening the stack.
  2. Modifying the backing file externally.
  3. UI updating to reflect the new file content.
  4. Performing a UI action DOES NOT revert the external change.

## Verification Plan

### Automated Tests
- `npm run e2e -- --spec tests/e2e/sync_robustness.spec.ts`
- Manual check on Desktop for duration button clicks.

### Manual Verification
- Test with Obsidian Sync by modifying the stack on one device and observing the update on the other.
